---
output:
  bookdown::pdf_document2: 
    toc: FALSE
fontsize: 12pt
header-includes:
  - \usepackage{xcolor}
  - \usepackage{float}
  - \usepackage{tabu}
  - \usepackage{multirow}
  - \usepackage{colortbl}
params:
  current.year: 2017
---

---
title: "`r paste("Local Authority Parking Finances in Wales", params$current.year, "-", params$current.year-1999)`"

---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo = FALSE)

## preliminaries ###############################################################
# load packages
suppressWarnings(suppressMessages(library(kableExtra)))
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(tidyr)))
suppressWarnings(suppressMessages(library(tibble)))
suppressWarnings(suppressMessages(library(showtext)))
options(knitr.kable.NA = '')

# add font for plots
font_add(family = "meri", regular = here::here("data/01-raw/fonts/merriweather.google.ttf"))
showtext_auto()

# source functions
source(here::here("code/functions.R"))

# load data
master <- readRDS(here::here("data/03-processed/master.rds"))

# change the year variable 
current.year <- params$current.year

## data preparation ############################################################
# extract relevant country subset of data for all years
master %>% 
  filter(country == "Wales") %>% 
  mutate(surplus.total = income.total - expend.total) %>% 
  filter(year <= current.year) -> data.full

# only for the last four years
data.full %>% 
  filter(year >= current.year -4 & year <= current.year) -> data

```


```{r wal.surplus, echo = FALSE, message = FALSE, warning = FALSE}
# needs to be at the start because the intro requires data from here
data %>% 
  select(auth.name, year, surplus.total) %>% 
  spread(key = year, value = surplus.total) %>% 
  full_join(data %>% 
              select(auth.name, year, transport.total) %>% 
              filter(year == current.year)) %>% 
  select(-year) %>% 
  arrange(desc(.[[6]])) -> wal.surplus

wal.surplus %>% 
  filter(auth.name != "Total") %>% 
  mutate(change = ifelse(.[[6]] >=0, TRUE, FALSE)) %>% 
  group_by(change) %>% 
  summarise(n = n()) %>% 
  pull() -> surplus.bin


```

# Introduction
  
This note covers parking finances for the 22 local authorities in Wales. As in England and Scotland, local authorities are required to submit details of all their finances to the Welsh Government in a standard format. They are normally published in October, seven months after the financial year end. This report looks at the section on parking income and expenditure from `r paste0(current.year-4, "-", current.year-1999-4)` to `r paste0(current.year, "-", current.year-1999)`.

The published data is less comprehensive than in England and does not split out on- and off-street parking or show penalty income separately. The figures do not include any commercial off-street parking. In `r paste0(current.year, "-", current.year-1999)`, 

`r FunFirstup(xfun::numbers_to_words(surplus.bin[2]))` councils showed surpluses and `r xfun::numbers_to_words(surplus.bin[1])` showed deficits \color{red}(the same three councils as `r paste0(current.year-1, "-", current.year-1999-1)`). \color{black} All councils are now receiving income from parking, \color{red} although councils such as Blaenau Gwent (Ebbw Vale and Abertillery) and Torfaen (Pontypool and Cwmbran) offer free parking but still issue penalty charge notices. \color{black}

# Summary

```{r sum, echo = FALSE, message = FALSE, warning = FALSE}
yearz <- paste0("\\multirow{1}{*}[0pt]{",(current.year-4):(current.year), "-", (current.year-4-1999):(current.year-1999),"}")

data %>% 
  select(year, income.total, expend.total, surplus.total, transport.total) %>% 
  group_by(year) %>% 
  summarise_at(vars(income.total:transport.total), sum) %>% 
  mutate_at(vars(income.total:transport.total), list(~./1000)) %>% 
  mutate(surplus.of.transport = 100 * surplus.total/transport.total) %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>%
  filter(rowname != "year") %>%
  mutate(change = V5/V4 *100 -100)  -> wal.summary

wal.summary %>% 
  mutate(change = ifelse(rowname == "surplus.of.transport", NA, 
                         paste(format(round(change, 2), nsmall = 2), "\\%"))) %>% 
  mutate(rowname = c("Income", "Expenditure", "Surplus", "Net cost", "Parking surplus as percentage of all transport costs")) %>% 
    mutate_at(vars(V1:V5), function(x) FunDec(x, 2)) %>% 
    mutate_at(vars(V1:V5), function(x) ifelse(.$rowname == "Parking surplus as percentage of all transport costs", paste0(x, " \\%"), x)) %>%
  mutate(collapsed = c(rep("Parking", 3), "Total transport", "")) %>% 
  select(collapsed, rowname:change) %>% 
  kable( "latex", 
         booktabs = T, 
         digits = 2, 
         escape = F,
         align = c("r"),
         caption = "Summary of parking accounts for Wales",
         col.names = c("", "", yearz, paste0("Change ", current.year, "-", 
current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1:2, width = "3cm") 
```

Table @ref(tab:sum) above shows the summary accounts for local authorities in Wales of the incomes and expenditures arising from parking charges and penalty income both for on- and off-street parking. The income has 
`r ifelse(wal.summary$change[1] < -0.02, paste("fallen by", format(-wal.summary$change[1], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[1], digits = 2), "%"),"stayed approximately the same"))`, the expenditure has 
`r ifelse(wal.summary$change[2] < -0.02, paste("fallen by", format(-wal.summary$change[2], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[2], digits = 2), "%"),"stayed approximately the same"))` and the surplus has
`r ifelse(wal.summary$change[3] < -0.02, paste("fallen by", format(-wal.summary$change[3], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[3], digits = 2), "%"),"stayed approximately the same"))`
compared to the previous fiscal year. Total transport has
`r ifelse(wal.summary$change[4] < -0.02, paste("fallen by", format(-wal.summary$change[4], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[4], digits = 2), "%"),"stayed approximately the same"))` and the surplus now represents `r paste(format(wal.summary$V5[5], digits = 2), "%")` of transport costs. 

```{r echo = FALSE}
# extract relevant subset of data 
master %>% 
  filter(country == "England") %>% 
  filter(year == current.year) %>% 
  mutate(income.total = income.on + income.off,
         expend.total = expend.on + expend.off,
         surplus.total = income.total - expend.total,
         group = recode(auth.type, "X" = "X", 
                        .default = "LA")) %>% 
  summarise(transport = sum(transport.total, na.rm = TRUE),
            surplus = sum(surplus.total, na.rm = TRUE)) %>% 
  mutate(proportion = 100*surplus/transport) %>% 
  pull(proportion)  -> eng.trans
```

Parking makes a 
`r ifelse(wal.summary$V5[5] < eng.trans - 0.02 , "smaller", ifelse(wal.summary$V5[5] > eng.trans + 0.02,  "larger","similar"))` contribution to overall transport costs in Wales compared with England where it is around `r format(eng.trans, digits = 2)` % of total transport. Figure @ref(fig:fig1) gives a longer term overview of the trends in incomes, expenditures and surpluses. 

```{r fig1, echo = FALSE, fig.cap = "Parking revenues--Wales", fig.showtext=TRUE,}

data.full  %>% 
select(year, income.total, expend.total, surplus.total) %>% 
  group_by(year) %>% 
  summarise_at(vars(income.total:surplus.total), sum) %>% 
  mutate_at(vars(income.total:surplus.total), list(~./1000)) -> data.plot
old.par <- par(mar = c(5.1, 4.1, 3.1, 2.1))
plot(data.plot$year, data.plot$income.total, 
     ylim = c(0, max(data.plot$income.total)), 
     type = "l",
     lwd = 2,
     col = "darkblue",
     bty = "n",
     xlab = "Fiscal Year",
     ylab = "£ (millions)",
     axes = FALSE, family = "meri", cex.lab = 0.8)
axis(1, at = data.plot$year, 
     labels = rep("", length(data.plot$year),
     family = "meri", cex.axis = 0.6, las = 2, srt = 45))
text(data.plot$year, par("usr")[3] - 0.5, 
     labels = paste0(data.plot$year, "-", data.plot$year-1999), 
     srt = 45, adj = c(1.2,1.5), xpd = TRUE, family = "meri", cex = 0.6)
axis(2, las = 2, family = "meri", cex.axis = 0.6 )
grid(nx = NA, ny = NULL, lty = "93")
lines(data.plot$year, data.plot$expend.total, 
     ylim = c(0, max(data.plot$expend.total)), 
     type = "l",
     lwd = 2,
     col = "coral3")
lines(data.plot$year, data.plot$surplus.total, 
     ylim = c(0, max(data.plot$surplus.total)), 
     type = "l",
     lwd = 2,
     col = "chartreuse3")
par(family = "meri")
legend("topleft",
       legend = c("Income", "Expenditure", "Surplus"),
       bty = "n",
       col = c("darkblue", "coral3", "chartreuse3"), 
       lwd = 2, cex = 0.8, xpd= TRUE)
par(old.par)
```

\newpage

# Income

Total council parking income from all sources in `r paste0(current.year, "-", current.year-1999)` was £`r format(wal.summary$V5[1], digits = 2)` million, `r format(wal.summary$change[1], digits = 2)` % `r ifelse (wal.summary$change[1] > 0, "higher", "lower")` than `r paste0(current.year-1, "-", current.year-1999-1)`. Note that this includes penalty income, which is not shown separately, but does not include off-street income received by commercial off-street parking facilities. Table @ref(tab:income) ranks the Welsh councils in terms of parking income. 

```{r wal.income, echo = FALSE, message = FALSE, warning = FALSE}
# clean up income data
data %>% 
  select(auth.name, year, income.total) %>% 
  spread(key = year, value = income.total) %>% 
  arrange(desc(.[[6]])) %>% 
  bind_rows(group_by(. ,auth.name) %>%
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name='Total')) %>% 
    mutate(change =100*(.[[6]]/.[[5]]-1)) -> wal.income

# no income councils
wal.no.income <- nrow(filter(wal.income, !!as.name(current.year) == 0))

# split into increase/decrease and NA
wal.income %>% 
  mutate(change = ifelse(change >=0, TRUE, FALSE)) %>% 
  filter(auth.name != "Total") %>% 
  group_by(change) %>% 
  summarise(n = n()) %>% 
  deframe() -> income.bin

# select only valid
wal.income %>% 
  filter(auth.name != "Total") %>% 
  arrange(desc(change)) %>% 
  filter(!is.nan(change) & !is.infinite(change)) -> wal.income.valid

# get top three LAs and proportion they command
wal.income.valid %>% 
  arrange(desc(!!as.name(current.year))) %>% 
  group_by(row_number() ==1, row_number() ==2, row_number() == 3, row_number() > 3) %>% 
  mutate(sum = sum(!!as.name(current.year))) %>% 
  ungroup() %>% 
  filter(row_number() <= 4) %>% 
  mutate(auth.name = ifelse(row_number() == 4, "Other", auth.name)) %>% 
  select(auth.name, sum)  %>% 
  mutate(total = sum(sum)) %>% 
  group_by(auth.name == "Other") %>% 
  mutate(proportion = 100*sum(sum)/total) %>% 
  ungroup() %>% 
  select(auth.name, proportion) %>% 
  deframe() -> wal.income.top3

# extract bottom LAs where income is under 30.000
wal.income.valid %>% 
  filter(row_number() %in% c(n(), n()-1) & !!as.name(current.year) <= 30) -> wal.income.exclude.bottom

# extract top LAs where expenditure is under 30.000
wal.income.valid %>% 
  filter(row_number() %in% c(1, 2, 3) & !!as.name(current.year) <= 30) -> wal.income.exclude.top

# remove excluded rows and select top 3 and bottom 2
wal.income.valid %>% 
  anti_join(wal.income.exclude.top) %>% 
  anti_join(wal.income.exclude.bottom) %>% 
  filter(row_number() %in% c(1, 2, 3, n()-1, n())) %>% 
  select(auth.name, change, !!as.name(current.year)) -> wal.income.top.bottom
```

`r FunFirstup(xfun::numbers_to_words(income.bin[2]))` councils increased their income over the past year and `r xfun::numbers_to_words(income.bin[1])` decreased their income. `r if (wal.no.income > 0 ) {paste0(FunFirstup(xfun::numbers_to_words(wal.no.income)), " councils did not show any income in ", FunFisc(), ".")}`

The top three Welsh councils by income were `r paste0(names(wal.income.top3)[1], ", ", names(wal.income.top3)[2], ", and ", names(wal.income.top3)[3])`, and between them accounted for `r FunDec(wal.income.top3[1], 1)` % of parking income.

`r wal.income.top.bottom[1,1]` increased their income by `r FunDec(wal.income.top.bottom[1,2], 0)` %
while `r wal.income.top.bottom[2,1]` and `r wal.income.top.bottom[3,1]` increased  by `r FunDec(wal.income.top.bottom[2,2], 0)` % and `r FunDec(wal.income.top.bottom[3,2], 0)` % respectively`r ifelse(nrow(wal.income.exclude.top) == 0, ".", ifelse(nrow(wal.income.exclude.top) == 1, paste(", excluding", wal.income.exclude.top[1], "where the income is very low."), ifelse(nrow(wal.income.exclude.top) == 2,  paste(", excluding", wal.income.exclude.top[1,1], ", and", wal.income.exclude.top[2,1], "where the income is very low."), paste0(", excluding ", wal.income.exclude.top[1,1], ", ", wal.income.exclude.top[2,1], ", and ", wal.income.exclude.top[3,1], " where the income is very low."))))` The biggest decreases were in `r wal.income.top.bottom[5,1]` (`r FunDec(abs(wal.income.top.bottom[5,2]), 0)` %), and `r wal.income.top.bottom[4,1]` (`r FunDec(abs(wal.income.top.bottom[4,2]),0)` %) `r ifelse(nrow(wal.income.exclude.bottom) == 0, ".", ifelse(nrow(wal.income.exclude.bottom) == 1, paste(" (excluding", wal.income.exclude.bottom[1], "where the income is very low)."),   paste(" (excluding", wal.income.exclude.bottom[1,1], ", and", wal.income.exclude.bottom[2,1], "where the income is very low).")))`


\renewcommand{\arraystretch}{1.2}
```{r income, echo = FALSE, message = FALSE, warning = FALSE}

wal.income %>% 
  mutate(change = ifelse(is.na(change), NA, 
                         paste(format(round(change, 1), nsmall = 1), "\\%"))) %>% 
   kable( "latex", 
         booktabs = T, 
         digits = c(rep(0, 6), 2), 
         escape = F,
         align = c("r"),
         caption = "Parking income for Wales (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, paste0("Change ", current.year, "-", current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1, width = "4cm") %>% 
  row_spec(22, hline_after = TRUE)
  
```

\newpage

# Expenditures

```{r wal.expend, echo = FALSE, message = FALSE, warning = FALSE}
# get wales totals for expenditure for each year in data,
# caluclate change on previous year and proportion of income
data %>% 
  select(auth.name, year, expend.total) %>% 
  spread(key = year, value = expend.total) %>% 
  full_join(data %>% 
              select(auth.name, year, income.total) %>% 
              filter(year == current.year)) %>% 
  select(-year) %>% 
  arrange(desc(.[[6]])) %>% 
  bind_rows(group_by(. ,auth.name) %>%
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name='Total')) %>% 
  mutate(change =100*(.[[6]]/.[[5]]-1),
         prop.income = 100*.[[6]]/.[[7]]) %>% 
  select(-income.total)-> wal.expend

# calculate change and prop of income for Scotland total row. 
wal.expend %>% 
  filter(auth.name == "Total") %>% 
  mutate(current.change = (.[[6]]-.[[5]])/1000,
         last.change = (.[[5]]-.[[4]])/1000) %>% 
  select(change, current.change, last.change) -> wal.expend.t

# count councils with +/- change
wal.expend %>% 
  filter(auth.name != "Total") %>% 
  mutate(change = ifelse(change >=0, TRUE, FALSE)) %>% 
  group_by(change) %>% 
  summarise(n = n()) %>% 
  deframe() -> expend.bin

# select only valid
wal.expend %>% 
  filter(auth.name != "Total") %>% 
  arrange(desc(change)) %>% 
  filter(!is.nan(change) & !is.infinite(change)) -> wal.expend.valid
    
# extract bottom LAs where expenditure is under 30.000
 wal.expend.valid %>% 
  filter(row_number() %in% c(n(), n()-1) & !!as.name(current.year) <= 30) -> wal.expend.exclude.bottom

# extract top LAs where expenditure is under 30.000
 wal.expend.valid %>% 
  filter(row_number() %in% c(1, 2, 3) & !!as.name(current.year) <= 30) -> wal.expend.exclude.top

# remove excluded rows and select top 3 and bottom 2
wal.expend.valid %>% 
  anti_join(wal.expend.exclude.top) %>% 
  anti_join(wal.expend.exclude.bottom) %>% 
  filter(row_number() %in% c(1, 2, 3, n()-1, n())) %>% 
  select(auth.name, change, !!as.name(current.year)) -> wal.expend.top.bottom

# compare Cardif to total by expenditure as prop of income
wal.expend %>% 
  select(auth.name, prop.income) %>% 
  filter(auth.name %in% c("Total", "Cardiff")) %>% 
  pull(prop.income) -> wal.expend.p

```
Table @ref(tab:expend) ranks the councils in terms of expenditure on parking.

Overall expenditure has `r ifelse( wal.expend.t[2] > 0, "risen", "fallen")` by £`r FunDec(abs(wal.expend.t[2]),1)`m (`r FunDec(abs(wal.expend.t[1]),1)` %) after a `r ifelse( wal.expend.t[3] > 0, paste0("rise of £", FunDec(wal.expend.t[3], 1), "m last year"), paste0("fall of £", FunDec(abs(wal.expend.t[3]),1), "m last year"))`, with `r xfun::numbers_to_words(expend.bin[2])` councils having increased their and `r xfun::numbers_to_words(expend.bin[1])` reduced their costs.  



The largest increase in expenditure happened in`r wal.expend.top.bottom[1,1]`, where it increased  by `r FunDec(wal.expend.top.bottom[1,2], 0)` %, 
while `r wal.expend.top.bottom[2,1]` and `r wal.expend.top.bottom[3,1]` increased  by `r FunDec(wal.expend.top.bottom[2,2], 0)` % and `r FunDec(wal.expend.top.bottom[3,2], 0)` % respectively 
`r ifelse(nrow(wal.expend.exclude.top) == 0, ".", ifelse(nrow(wal.expend.exclude.top) == 1, paste(", excluding", wal.expend.exclude.top[1], "where the expenditure spending is very low."), ifelse(nrow(wal.expend.exclude.top) == 2,  paste(", excluding", wal.expend.exclude.top[1,1], ", and", wal.expend.exclude.top[2,1], "where the expenditure spending is very low."), paste0(", excluding ", wal.expend.exclude.top[1,1], ", ", wal.expend.exclude.top[2,1], ", and ", wal.expend.exclude.top[3,1], " where the expenditure spending is very low."))))` The biggest decreases were in `r wal.expend.top.bottom[5,1]` (`r FunDec(abs(wal.expend.top.bottom[5,2]), 0)` %), and `r wal.expend.top.bottom[4,1]` (`r FunDec(abs(wal.expend.top.bottom[4,2]),0)` %) `r ifelse(nrow(wal.expend.exclude.bottom) == 0, ".", ifelse(nrow(wal.expend.exclude.bottom) == 1, paste(" (excluding", wal.expend.exclude.bottom[1], "where the expenditure spending is very low)."),   paste(" (excluding", wal.expend.exclude.bottom[1,1], ", and", wal.expend.exclude.bottom[2,1], "where the expenditure spending is very low).")))`


The table also shows the proportion of income taken up by costs in `r paste0(current.year, "-", current.year-1999)`. Nationally in Wales it is `r format(round(wal.expend.p[2],1), nsmall = 1)` % with Cardiff at `r format(round(wal.expend.p[1],1), nsmall = 1)` %.

```{r expend, echo = FALSE, message = FALSE, warning = FALSE}

wal.expend %>% 
  mutate(change = paste(format(round(change, 1),nsmall = 1), "\\%"),
         prop.income = paste(format(round(prop.income, 1),nsmall = 1), "\\%")) %>% 
   kable( "latex", 
         booktabs = T, 
         digits = 0, 
         escape = F,
         align = c("r"),
         caption = "Parking expenditure for Wales (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, 
                       paste0("Change ", current.year, "-", current.year-1999, 
                              " on ", current.year-1, "-", current.year-1999-1), "Expenditure as proportion of income")) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1, width = "3.3cm") %>% 
  column_spec(8, width = "1.8cm") %>% 
  row_spec(22, hline_after = TRUE)
  
```

\newpage

# Surpluses

Table @ref(tab:surplus) shows the parking surpluses from from `r paste0(current.year-4, "-", current.year-1999-4)` to `r paste0(current.year, "-", current.year-1999)` and the change from
`r paste0(current.year-1, "-", current.year-1999-1)` to `r paste0(current.year, "-", current.year-1999)`. It also shows the proportion that parking surpluses represent of
total transport expenditure.

```{r surplus, echo = FALSE, message = FALSE, warning = FALSE}
# create totals row for surpluses and deficits. 
data %>% 
  select(auth.name, year, surplus.total, transport.total) %>% 
  mutate(poz.neg = ifelse(surplus.total >= 0, "poz", "neg")) %>% 
  group_by(year, poz.neg) %>%
  summarise_at(vars(-auth.name), list(~sum)) %>%
  gather(variable, value, -c(year, poz.neg)) %>%
  unite(temp, year, variable) %>%
  spread(temp, value) %>% 
  select(poz.neg, contains("surplus"), paste0(current.year, "_transport.total"))  %>% 
  mutate(poz.neg = c("Total deficit", "Total surplus")) %>% 
  rename_all(~ c("auth.name", (current.year-4):(current.year), "transport.total")) %>% 
  bind_rows(group_by(., auth.name) %>% 
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name = c("Total"))) -> wal.surplus.totals

# bind both tables together
bind_rows(wal.surplus, wal.surplus.totals) %>% 
  mutate(change =100*(.[[6]]/.[[5]]-1),
         prop.transp = 100*.[[6]]/.[[7]]) %>% 
  select(-transport.total) -> wal.surplus.totals.table

# extract top three proportion 
wal.surplus %>% 
  select(auth.name, 6) %>% 
  filter(.[[2]] >= 0) %>% 
  mutate(top.three = ifelse(row_number() < 4, "top", "not")) %>% 
  group_by(top.three) %>% 
  summarise(sum = sum(!!as.name(current.year)),
            count = n()) %>% 
  mutate(prop = sum/sum(sum)) -> wal.surplus.t3

# setup table
wal.surplus.totals.table %>% 
  mutate(change = paste(format(round(change, 1),nsmall = 1), "%"),
         prop.transp = paste(format(round(prop.transp, 1),nsmall = 1), "\\%")) %>% 
  mutate(change =cell_spec(change, "latex", italic =ifelse(.[[6]] < 0, TRUE, FALSE))) %>% 
  kable( "latex", 
         booktabs = T, 
         digits = 0, 
         escape = F,
         align = c("r"),
         caption = "Parking surpluses for Wales (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, 
                       paste0("Change ", current.year, "-", current.year-1999, 
                              " on ", current.year-1, "-", current.year-1999-1), "Surplus as proportion of transport spending")) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped"), 
                font_size = 10) %>% 
  column_spec(1, width = "3.3cm") %>% 
  row_spec(c(22, 24), hline_after = TRUE) %>% 
  footnote(symbol = "Where the change in surplus is actually a change in deficit, the values are in italics")

```


The total *net surplus* for Wales was £`r FunDec((wal.surplus.totals.table[25, 6]/1000),1)`m. Total parking surpluses amount to £`r FunDec((wal.surplus.totals.table[24, 6]/1000),1)`m between `r  sum(wal.surplus.t3$count) ` authorities of which Cardiff, Swansea and Gwynedd contribute `r  FunDec(100*wal.surplus.t3$prop[2],1)`%. \color{red} XXXX increased its surplus significantly because of the sharp reduction in cost. \color{black} `r FunFirstup(xfun::numbers_to_words(surplus.bin[1]))` councils made a loss with the total of parking deficits `r ifelse(wal.surplus.totals.table[23,6] > wal.surplus.totals.table[23,5], "falling", "rising")` to £`r FunDec(-wal.surplus.totals.table[23,6]/1000,1)`m from £`r FunDec(-wal.surplus.totals.table[23,5]/1000,1)`m last year \color{red} mainly because of a reduction
in the loss in XXXX with its big fall in expenditure.\color{black}

## References {-}

*Still to come*
