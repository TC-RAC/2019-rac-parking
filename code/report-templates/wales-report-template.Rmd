---
output:
  bookdown::pdf_document2: 
    toc: FALSE
fontsize: 11pt
header-includes:
  - \usepackage{xcolor}
---
```{r, echo = FALSE}
# change the year variable 
current.year <- 2017
```

---
title: "`r paste("Local Authority Parking Finances in Wales", current.year, "-", current.year-1999)`"
---


```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo = FALSE)

# preliminaries
suppressWarnings(suppressMessages(library(kableExtra)))
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(tidyr)))
suppressWarnings(suppressMessages(library(showtext)))
options(knitr.kable.NA = '')
font_add_google("Merriweather", "meri")
showtext_auto()
# load data
master <- readRDS(here::here("data/03-processed/master.rds"))

# extract relevant subset of data
# for all years
master %>% 
  filter(country == "Wales") %>% 
  mutate(surplus.total = income.total - expend.total) -> data.full

# only for the last four years
data.full %>% 
  filter(year >= current.year -4 & year <= current.year) -> data


```


# Introduction
  
This note covers parking finances for the 22 local authorities in Wales. As in England and Scotland, local authorities are required to submit details of all their finances to the Welsh Government in a standard format. They are normally published in October, seven months after the financial year end. This report looks at the section on parking income and expenditure from `r paste0(current.year-4, "-", current.year-1999-4)` to `r paste0(current.year, "-", current.year-1999)`.

The published data is less comprehensive than in England and does not split out on- and off-street parking or show penalty income separately. The figures do not include any commercial off-street parking. In `r paste0(current.year, "-", current.year-1999)`, *19 councils showed surpluses and
three showed deficits (the same three councils as 2016-17).* All councils are now receiving income from parking, \color{red} although councils such as Blaenau Gwent (Ebbw Vale and Abertillery) and Torfaen (Pontypool and Cwmbran) offer free parking but still issue penalty charge notices. \color{black}

# Summary

```{r sum, echo = FALSE, message = FALSE, warning = FALSE}
yearz <- paste0("\\multirow{1}{*}[0pt]{",(current.year-4):(current.year), "-", (current.year-4-1999):(current.year-1999),"}")

data %>% 
  select(year, income.total, expend.total, surplus.total, transport.total) %>% 
  group_by(year) %>% 
  summarise_at(vars(income.total:transport.total), sum) %>% 
  mutate_at(vars(income.total:transport.total), list(~./1000)) %>% 
  mutate(surplus.of.transport = 100 * surplus.total/transport.total) %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>%
  filter(rowname != "year") %>%
  mutate(change = V5/V4 *100 -100)  -> wal.summary

wal.summary %>% 
  mutate(change = ifelse(rowname == "surplus.of.transport", NA, 
                         paste(format(round(change, 2), nsmall = 2), "\\%"))) %>% 
  mutate(rowname = c("Income", "Expenditure", "Surplus", "Net cost", "Parking surplus as percentage of all transport costs")) %>% 
  mutate(collapsed = c(rep("Parking", 3), "Total transport", "")) %>% 
  select(collapsed, rowname:change) %>% 
  kable( "latex", 
         booktabs = T, 
         digits = 2, 
         escape = F,
         align = c("r"),
         caption = "Summary of parking accounts for Wales",
         col.names = c("", "", yearz, paste0("Change ", current.year, "-", 
current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("hold_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1:2, width = "3cm") 
```

Table @ref(tab:sum) above shows the summary accounts for local authorities in Wales of the incomes and expenditures arising from parking charges and penalty income both for on- and off-street parking. The income has 
`r ifelse(wal.summary$change[1] < -0.02, paste("fallen by", format(-wal.summary$change[1], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[1], digits = 2), "%"),"stayed approximately the same"))`, the expenditure has 
`r ifelse(wal.summary$change[2] < -0.02, paste("fallen by", format(-wal.summary$change[2], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[2], digits = 2), "%"),"stayed approximately the same"))` and the surplus has
`r ifelse(wal.summary$change[3] < -0.02, paste("fallen by", format(-wal.summary$change[3], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[3], digits = 2), "%"),"stayed approximately the same"))`
compared to the previous fiscal year. Total transport
`r ifelse(wal.summary$change[4] < -0.02, paste("fallen by", format(-wal.summary$change[4], digits = 2), "%"), ifelse(wal.summary$change[1] > 0.02, paste("increased by", format(wal.summary$change[4], digits = 2), "%"),"stayed approximately the same"))` and the surplus now represents `r paste(format(wal.summary$V5[5], digits = 2), "%")` of transport costs. 

```{r echo = FALSE}
# extract relevant subset of data 
master %>% 
  filter(country == "England") %>% 
  filter(year == current.year) %>% 
  mutate(income.total = income.on + income.off,
         expend.total = expend.on + expend.off,
         surplus.total = income.total - expend.total,
         group = recode(auth.type, "X" = "X", 
                        .default = "LA")) %>% 
  summarise(transport = sum(transport.total, na.rm = TRUE),
            surplus = sum(surplus.total, na.rm = TRUE)) %>% 
  mutate(proportion = 100*surplus/transport) %>% 
  pull(proportion)  -> eng.trans
```

Parking makes a 
`r ifelse(wal.summary$V5[5] < eng.trans - 0.02 , "smaller", ifelse(wal.summary$V5[5] > eng.trans + 0.02,  "larger","similar"))` contribution to overall transport costs in Wales compared with England where it is around `r format(eng.trans, digits = 2)` % of total transport. Figure @ref(fig:fig1) gives a longer term overview of the trends in incomes, expenditures and surpluses. 

```{r fig1, echo = FALSE, fig.cap = "Parking revenues--Wales", fig.showtext=TRUE,}

data.full  %>% 
select(year, income.total, expend.total, surplus.total) %>% 
  group_by(year) %>% 
  summarise_at(vars(income.total:surplus.total), sum) %>% 
  mutate_at(vars(income.total:surplus.total), list(~./1000)) -> data.plot

plot(data.plot$year, data.plot$income.total, 
     ylim = c(0, max(data.plot$income.total)), 
     type = "l",
     lwd = 2,
     col = "darkblue",
     bty = "n",
     xlab = "Fiscal Year",
     ylab = "£ (millions)",
     axes = FALSE, family = "meri", cex.lab = 0.8)
axis(1, at = data.plot$year, 
     labels = rep("", length(data.plot$year),
     family = "meri", cex.axis = 0.6, las = 2, srt = 45))
text(data.plot$year, par("usr")[3] - 0.5, 
     labels = paste0(data.plot$year, "-", data.plot$year-1999), 
     srt = 45, adj = c(1.2,1.5), xpd = TRUE, family = "meri", cex = 0.6)
axis(2, las = 2, family = "meri", cex.axis = 0.6 )
grid(nx = NA, ny = NULL, lty = "93")
lines(data.plot$year, data.plot$expend.total, 
     ylim = c(0, max(data.plot$expend.total)), 
     type = "l",
     lwd = 2,
     col = "coral3")
lines(data.plot$year, data.plot$surplus.total, 
     ylim = c(0, max(data.plot$surplus.total)), 
     type = "l",
     lwd = 2,
     col = "chartreuse3")
par(family = "meri")
legend("topleft",
       legend = c("Income", "Expenditure", "Surplus"),
       bty = "n",
       col = c("darkblue", "coral3", "chartreuse3"), 
       lwd = 2, cex = 0.7)
```

# Income

Total council parking income from all sources in `r paste0(current.year, "-", current.year-1999)` was £`r format(wal.summary$V5[1], digits = 2)` million, `r format(wal.summary$change[1], digits = 2)` % `r ifelse (wal.summary$change[1] > 0, "higher", "lower")` than `r paste0(current.year-1, "-", current.year-1999-1)`. Note that this includes penalty income, which is not shown separately, but does not include off-street income received by commercial off-street parking facilities. 


*Eleven councils increased their income over the past year and a
similar number decreased their income. Merthyr Tydfil saw income increase by 19%
while Cardiff and Wrexham increased by 14%. The largest falls were Rhondda Cynon
Taf (18%) Denbighshire (11%) (excluding Torfaen where the income is very low).*

\renewcommand{\arraystretch}{1.2}
```{r income, echo = FALSE, message = FALSE, warning = FALSE}

data %>% 
  select(auth.name, year, income.total) %>% 
  spread(key = year, value = income.total) %>% 
  arrange(desc(.[[6]])) %>% 
  bind_rows(group_by(. ,auth.name) %>%
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name='Total')) %>% 
    mutate(change =100*(.[[6]]/.[[5]]-1)) -> wal.income

wal.income %>% 
  mutate(change = ifelse(is.na(change), NA, 
                         paste(format(change, digits = 2), "\\%"))) %>% 
   kable( "latex", 
         booktabs = T, 
         digits = c(rep(0, 6), 2), 
         escape = F,
         align = c("r"),
         caption = "Parking income for Wales (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, paste0("Change ", current.year, "-", current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("hold_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1, width = "4cm") %>% 
  row_spec(22, hline_after = TRUE)
  
```

# Expenditures

```{r expend, echo = FALSE, message = FALSE, warning = FALSE}

data %>% 
  select(auth.name, year, expend.total) %>% 
  spread(key = year, value = expend.total) %>% 
  arrange(desc(.[[6]])) %>% 
  bind_rows(group_by(. ,auth.name) %>%
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name='Total')) %>% 
    mutate(change =100*(.[[6]]/.[[5]]-1)) -> wal.expend

wal.expend %>% 
  mutate(change = ifelse(is.na(change), NA, 
                         paste(format(round(change, 2),nsmall = 2), "\\%"))) %>% 
   kable( "latex", 
         booktabs = T, 
         digits = 0, 
         escape = F,
         align = c("r"),
         caption = "Parking expenditure for Wales (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, paste0("Change ", current.year, "-", current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("hold_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1, width = "4cm") %>% 
  row_spec(22, hline_after = TRUE)
  
```