---
output:
  bookdown::pdf_document2: 
    toc: FALSE
fontsize: 12pt
header-includes:
  - \usepackage{xcolor}
  - \usepackage{float}
  - \usepackage{tabu}
  - \usepackage{multirow}
  - \usepackage{colortbl}
params:
  current.year: 2016
---

---
  title: "`r paste("Local Authority Parking Finances in Wales", params$current.year, "-", params$current.year-1999)`"
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo = FALSE)

## preliminaries ###############################################################
# load packages
suppressWarnings(suppressMessages(library(kableExtra)))
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(tidyr)))
suppressWarnings(suppressMessages(library(showtext)))
suppressWarnings(suppressMessages(library(sf)))
options(knitr.kable.NA = '')

# add font for plots
font_add(family = "meri", regular = here::here("data/01-raw/fonts/merriweather.google.ttf"))
showtext_auto()

# source functions
source(here::here("code/functions.R"))

# load data
master <- readRDS(here::here("data/03-processed/master.rds"))
orig.sco.name.lookup <- readRDS(here::here("data/01-raw/orig.sco.name.lookup.rds"))
uc <- st_read(here::here("data/01-raw/maps/Local_Administrative_Units_Level_1_January_2018_Ultra_Generalised_Clipped_Boundaries_in_United_Kingdom.shp"), quiet = TRUE)

# change the year variable 
current.year <- 2016 # params$current.year

## data preparation ############################################################
# extract relevant country subset of data for all years
master %>% 
  filter(country == "Scotland") %>% 
  mutate(surplus.total = income.total - expend.total) %>% 
  filter(year <= current.year) -> data.full

# only for the last four years
data.full %>% 
  filter(year >= current.year -4 & year <= current.year) -> data

# data for current year only
data %>% 
  filter(year == current.year) -> data.current
```

This note covers parking finances for the 32 local authorities in Scotland. They are required to submit details of their finances to the Scottish Government annually in a standard format. The figures are normally published in March, nearly a year after the financial year end. This note looks at the section on parking income and expenditure for `r paste0(current.year-4, "-", current.year-1999-4)` to `r paste0(current.year, "-", current.year-1999)`. 

In addition, Transport Scotland is now publishing an annual report on decriminalised parking - the latest being: *Decriminalised Parking Enforcement – Local Authorities’ Income and Expenditure:* `r current.year` to `r current.year + 1`,  which follows on from a report published in 2016 by the Scottish Parliament Rural Economy and Connectivity Committee that showed for the first time the number of Penalty Charge Notices (PCNs) issued and penalty income raised in Scotland for the years 2013-14 to 2015-16. 


The Transport for Scotland report deals with the statutory returns which are required by councils operating Decriminalised Parking Enforcement (DPE) to show how the surpluses are reinvested in transport activities. The local finance figures also include non-DPE activities, primarily off-street parking.

# Introduction

Table 1 shows that as of \color{red}December \color{black} `r current.year`, *16* councils were operating DPE (using local traffic wardens and civil enforcement), while two more were actively working towards DPE, \color{red}one of which--Midlothian--introduced DPE in January 2018. \color{black} The remaining ten authorities were not currently considering DPE, but still use fixed penalty notices issued instead of fines enforced by the Justice of the Peace courts. 

Police Scotland no longer enforces parking offences but now deals only with dangerous parking (e.g. on pedestrian crossings) by local arrangement. Several of the authorities not using DPE have rejected it because of the cost of setting it up and running it for the small number of parking offences. 

\renewcommand{\arraystretch}{1.1}
```{r dpe }
data.current %>% 
  select(auth.name, dpe.status, dpe.year) %>% 
  arrange(dpe.status) %>% 
  group_by(dpe.status) %>% 
  mutate(id =  1:n())  %>% 
  ungroup() %>% 
  complete(dpe.status, nesting( id)) %>% 
  select(auth.name, dpe.status, dpe.year) %>% 
  gather(variable, value, -(dpe.status)) %>% 
  unite(temp, dpe.status, variable)  %>% 
  group_by(temp) %>% 
  mutate(id = 1:n()) %>% 
  spread(temp, value) %>% 
  select(-dpe.next_dpe.year, -dpe.not_dpe.year) %>% 
  unite(dpe.now, dpe.now_auth.name, dpe.now_dpe.year, sep = " (") %>% 
  mutate(dpe.now = paste0(dpe.now, ")")) %>% 
  rename(dpe.next = dpe.next_auth.name , dpe.not = dpe.not_auth.name) %>% 
  select(dpe.now, dpe.next, dpe.not) %>% 
 kable( "latex", 
         booktabs = T, 
         align = c("l"),
         linesep = "",
         caption = "Parking arrangements for local authorities in Scotland",
         col.names = c("Using DPE", "Considering using DPE", "Not using DPE")) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped"), 
                font_size = 10) 
```


```{r map1, fig.height = 4, fig.cap = "Map showing implementation of decriminalised parking in Scotland"}
uc %>% 
  filter(grepl("^S", lau118cd)) %>% 
  mutate(lau118nm = recode(lau118nm, !!!orig.sco.name.lookup)) %>% 
  left_join(select(data.current, auth.name, dpe.status), 
            by = c("lau118nm"= "auth.name")) ->sco

plot(sco["dpe.status"], main = "", pal = c("darkmagenta",  "darkgoldenrod1", "chartreuse3"),
     key.pos = NULL)

legend("topleft", fill = rev(c("darkmagenta",  "darkgoldenrod1", "chartreuse3")),
       legend = rev(c( "No DPE", "DPE being introduced", "DPE")), bty = "n",
       cex = 0.8)

```

# Summary 
```{r sum}
data %>% 
  select(year, auth.type, income.total, expend.total, 
         surplus.total, transport.total) %>% 
  group_by(year, auth.type) %>% 
  summarise_at(vars(income.total:transport.total), sum) %>% 
  select(-auth.type) %>% 
  summarise_at(vars(income.total:transport.total), list(~sum(.,na.rm=TRUE))) %>% 
  mutate_at(vars(income.total:transport.total), list(~./1000))  %>% 
  mutate(surplus.of.transport = 100 * surplus.total/transport.total) %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>%
  filter(rowname != "year") %>%
  mutate(change = V5/V4 *100 -100)  -> sco.summary
```
T
able @ref(tab:sumtab) and Figure X@ref(fig:fig1) show the summary accounts for local authorities in Scotland for fiscal years `r paste0(current.year-4, "-", current.year-1999-4)` to `r paste0(current.year, "-", current.year-1999)`. The income has 
`r ifelse(sco.summary$change[1] < -0.02, paste("fallen by", format(-sco.summary$change[1], digits = 2), "%"), ifelse(sco.summary$change[1] > 0.02, paste("increased by", format(sco.summary$change[1], digits = 2), "%"),"stayed approximately the same"))`, the expenditure has 
`r ifelse(sco.summary$change[2] < -0.02, paste("fallen by", format(-sco.summary$change[2], digits = 2), "%"), ifelse(sco.summary$change[1] > 0.02, paste("increased by", format(sco.summary$change[2], digits = 2), "%"),"stayed approximately the same"))`, and the surplus has
`r ifelse(sco.summary$change[3] < -0.02, paste("fallen by", format(-sco.summary$change[3], digits = 2), "%"), ifelse(sco.summary$change[1] > 0.02, paste("increased by", format(sco.summary$change[3], digits = 2), "%"),"stayed approximately the same"))`
compared to the previous fiscal year. Total transport has
`r ifelse(sco.summary$change[4] < -0.02, paste("fallen by", format(-sco.summary$change[4], digits = 2), "%"), ifelse(sco.summary$change[1] > 0.02, paste("increased by", format(sco.summary$change[4], digits = 2), "%"),"stayed approximately the same"))` and the surplus now represents `r paste(format(sco.summary$V5[5], digits = 2), "%")` of transport costs.

```{r sumtab, echo = FALSE, message = FALSE, warning = FALSE}
yearz <- paste0("\\multirow{1}{*}[0pt]{",(current.year-4):(current.year), "-", (current.year-4-1999):(current.year-1999),"}")

sco.summary %>% 
  mutate(change = ifelse(rowname == "surplus.of.transport", NA, 
                         paste(format(round(change, 2), nsmall = 2), "\\%"))) %>% 
  mutate(rowname = c("Income", "Expenditure", "Surplus", "Net cost", "Parking surplus as percentage of all transport costs")) %>% 
  mutate_at(vars(V1:V5), function(x) FunDec(x, 2)) %>% 
  mutate_at(vars(V1:V5), function(x) ifelse(.$rowname == "Parking surplus as percentage of all transport costs", paste0(x, " \\%"), x)) %>%
  mutate(collapsed = c(rep("Parking", 3), "Total transport", "")) %>% 
  select(collapsed, rowname:change) %>% 
  kable( "latex", 
         booktabs = T, 
         digits = 2, 
         escape = F,
         align = c("r"),
         caption = "Summary of parking accounts for Scotland",
         col.names = c("", "", yearz, paste0("Change ", current.year, "-", 
current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped"), 
                font_size = 10) %>% 
   column_spec(1:2, width = "3cm") 
```





```{r fig1, echo = FALSE, fig.cap = "Parking revenues--Scotland", fig.pos = "H", fig.showtext=TRUE,}

data.full  %>% 
  select(year, income.total, expend.total, surplus.total) %>% 
  group_by(year) %>% 
  summarise_at(vars(income.total:surplus.total), list(~sum(.,na.rm=TRUE))) %>% 
  mutate_at(vars(income.total:surplus.total), list(~./1000)) -> data.plot

old.par <- par(mar = c(5.1, 4.1, 3.1, 2.1))
plot(data.plot$year, data.plot$income.total, 
     ylim = c(0, max(data.plot$income.total) ), 
     type = "l",
     lwd = 2,
     col = "darkblue",
     bty = "n",
     xlab = "Fiscal Year",
     ylab = "£ (millions)",
     axes = FALSE, family = "meri", cex.lab = 0.8)
axis(1, at = data.plot$year, 
     labels = rep("", length(data.plot$year),
     family = "meri", cex.axis = 0.6, las = 2, srt = 45))
text(data.plot$year, par("usr")[3] - 0.5, 
     labels = paste0(data.plot$year, "-", data.plot$year-1999), 
     srt = 45, adj = c(1.2,1.5), xpd = TRUE, family = "meri", cex = 0.6)
axis(2, las = 2, family = "meri", cex.axis = 0.6 )
grid(nx = NA, ny = NULL, lty = "93")
lines(data.plot$year, data.plot$expend.total, 
     ylim = c(0, max(data.plot$expend.total)), 
     type = "l",
     lwd = 2,
     col = "coral3")
lines(data.plot$year, data.plot$surplus.total, 
     ylim = c(0, max(data.plot$surplus.total)), 
     type = "l",
     lwd = 2,
     col = "chartreuse3")
par(family = "meri")
legend("bottomright",
       legend = c("Income", "Expenditure", "Surplus"),
       bty = "n",
       col = c("darkblue", "coral3", "chartreuse3"), 
       lwd = 2, cex = 0.8,  xpd = TRUE)
par(old.par)
```

```{r echo = FALSE}
# extract relevant subset of data 
master %>% 
  filter(country == "England") %>% 
  filter(year == current.year) %>% 
  mutate(income.total = income.on + income.off,
         expend.total = expend.on + expend.off,
         surplus.total = income.total - expend.total,
         group = recode(auth.type, "X" = "X", 
                        .default = "LA")) %>% 
  summarise(transport = sum(transport.total, na.rm = TRUE),
            surplus = sum(surplus.total, na.rm = TRUE)) %>% 
  mutate(proportion = 100*surplus/transport) %>% 
  pull(proportion)  -> eng.trans
```

Parking makes a 
`r ifelse(sco.summary$V5[5] < eng.trans - 0.02 , "smaller", ifelse(sco.summary$V5[5] > eng.trans + 0.02,  "larger","similar"))` contribution to overall transport costs in Scotland compared with England where it is around `r format(eng.trans, digits = 2)` % of total transport. Figure @ref(fig:fig1) gives a longer term overview of the trends in incomes, expenditures and surpluses. 

*Income has risen more sharply than expenditure over the five years, meaning that the surplus has steadily increased. Table 3 provides a comparison with London, England excluding London, and Wales for 2016-17 while Table 4 shows the change between 2011-12 and 2016-17.I'll do these tables later*

#  Income

Total council parking income from all sources in `r paste0(current.year, "-", current.year-1999)` was £`r format(sco.summary$V5[1], digits = 2)` million, `r format(sco.summary$change[1], digits = 2)` % `r ifelse (sco.summary$change[1] > 0, "higher", "lower")` than `r paste0(current.year-1, "-", current.year-1999-1)`. Note that this includes meter and penalty income for on- and off-street parking, but does not include income received by private parking companies.  Table @ref(tab:income) ranks the Scottish councils in terms of parking income. 

The cities of Edinburgh, Glasgow and Aberdeen between them accounted for *71% *of parking income. Five councils did not show any income in 2016-17.


```{r sco.income, echo = FALSE, message = FALSE, warning = FALSE}
# clean up income data
data %>% 
  select(auth.name, year, income.total) %>% 
  spread(key = year, value = income.total) %>% 
  arrange(desc(.[[6]])) %>% 
  filter(auth.name != "Scotland") %>% 
  bind_rows(group_by(. ,auth.name) %>%
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name='Total')) %>% 
    mutate(change =100*(.[[6]]/.[[5]]-1)) -> sco.income

sco.income %>% 
  mutate(change = ifelse(change >=0, TRUE, FALSE)) %>% 
  filter(auth.name != "Total") %>% 
  group_by(change) %>% 
  summarise(n = n()) %>% 
  pull() -> income.bin

sco.income %>% 
  arrange(desc(change)) %>% 
  filter(!is.nan(change) & !is.infinite(change)) %>% 
  filter(row_number() %in% c(nrow(.), nrow(.)-1) &
           .[[6]] <= 30) -> sco.income.exclude

sco.income %>% 
  arrange(desc(change)) %>% 
  filter(!is.nan(change) & !is.infinite(change)) %>% 
  anti_join(sco.income.exclude) %>% 
  filter(row_number() %in% c(1,2, n()-1, n())) %>% 
  select(auth.name, change) -> top.bottom

```


`r FunFirstup(xfun::numbers_to_words(income.bin[2]))` councils increased their income over the past year and `r xfun::numbers_to_words(income.bin[1])` decreased their income. `r top.bottom[1,1]` saw income increase by `r format(round(top.bottom[1,2], 0), nsmall = 0)` %
while `r top.bottom[2,1]` increased its income by `r format(round(top.bottom[2,2], 0), nsmall = 0)` %. The largest falls were in `r top.bottom[4,1]` (`r format(round(top.bottom[4,2], 0), nsmall = 0)` %), and `r top.bottom[3,1]` (`r format(round(top.bottom[3,2], 0), nsmall = 0)` %)`r ifelse(nrow(sco.income.exclude) == 0, ".", ifelse(nrow(sco.income.exclude) == 1, paste(", excluding", sco.income.exclude[1], "where the income is very low."), paste(", excluding", sco.income.exclude[1,1], "and", sco.income.exclude[2,1], "where the income is very low.")))`

\renewcommand{\arraystretch}{1.2}
```{r income, echo = FALSE, message = FALSE, warning = FALSE}

sco.income %>% 
  mutate(change = ifelse(is.na(change), NA, 
                         paste(format(round(change, 1), nsmall = 1), "\\%"))) %>% 
   kable( "latex", 
         booktabs = T, 
         digits = c(rep(0, 6), 2), 
         escape = F,
         longtable = T,
         align = c("r"),
         caption = "Parking income for Scotland (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, paste0("Change ", current.year, "-", current.year-1999, " on ", current.year-1, "-", current.year-1999-1))) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("hold_position", "striped", "repeat_header"), 
                font_size = 10) %>% 
   column_spec(1, width = "4cm") %>% 
  row_spec(32, hline_after = TRUE)
  
```
 

\newpage

# Expenditures

```{r sco.expend, echo = FALSE, message = FALSE, warning = FALSE}

# get scotland totals for expenditure for each year in dta,
# caluclate change on previous year and proportion of income
data %>% 
  select(auth.name, year, expend.total) %>% 
  filter(auth.name != "Scotland") %>% 
  spread(key = year, value = expend.total) %>% 
  full_join(data %>% 
                filter(auth.name != "Scotland") %>% 
              select(auth.name, year, income.total) %>% 
              filter(year == current.year)) %>% 
  select(-year) %>% 
arrange(desc(.[[6]])) %>% 
  bind_rows(group_by(. ,auth.name) %>%
              ungroup() %>% 
              summarise_at(vars(-auth.name), list(~sum)) %>%
              mutate(auth.name='Total')) %>% 
    mutate(change =100*(.[[6]]/.[[5]]-1),
           prop.income = 100*.[[6]]/.[[7]]) %>% 
  select(-income.total)-> sco.expend

# calculate change and prop of income for Scotland total row. 
sco.expend %>% 
  filter(auth.name == "Total") %>% 
  mutate(current.change = (.[[6]]-.[[5]])/1000,
         last.change = (.[[5]]-.[[4]])/1000) %>% 
  select(change, current.change, last.change) -> sco.expend.t

# count councils with +/- change
sco.expend %>% 
  filter(auth.name != "Total") %>% 
  mutate(change = ifelse(change >=0, TRUE, FALSE)) %>% 
  group_by(change) %>% 
  summarise(n = n()) %>% 
  pull() -> expend.bin

sco.expend %>% 
  arrange(desc(change)) %>% 
  filter(!is.nan(change) & !is.infinite(change)) %>% 
  filter(row_number() %in% c(nrow(.), nrow(.)-1) &
           .[[6]] <= 30) -> sco.expend.exclude

sco.expend %>% 
  filter(auth.name != "Total") %>% 
  filter(!is.nan(change) & !is.infinite(change)) %>% 
  anti_join(sco.income.exclude) %>% 
  arrange(desc(change)) %>% 
  filter(row_number() %in% c(1, 2, 3, n()-1, n())) %>% 
  select(auth.name, change, 6) -> top.bottom

sco.expend %>% 
  select(auth.name, prop.income) %>% 
  filter(auth.name %in% c("Total", "Glasgow City", "Edinburgh City")) %>% 
  pull(prop.income) -> sco.expend.p

```

Table @ref(tab:expend) ranks the councils in terms of expenditure on parking.

Overall expenditure has `r ifelse( sco.expend.t[2] > 0, "risen", "fallen")` by £`r FunDec(abs(sco.expend.t[2]),1)`m (`r FunDec(abs(sco.expend.t[1]),1)` %) after a `r ifelse( sco.expend.t[3] > 0, paste0("rise of £", FunDec(sco.expend.t[3], 1), "m last year"), paste0("fall of £", FunDec(abs(sco.expend.t[3]),1), "m last year"))`, with `r xfun::numbers_to_words(expend.bin[2])` councils having increased their and `r xfun::numbers_to_words(expend.bin[1])` reduced their costs.  


`r top.bottom[1,1]` increased expenditure by `r FunDec(top.bottom[1,2], 0)` %
while `r top.bottom[2,1]` and `r top.bottom[3,1]` increased  by `r FunDec(top.bottom[2,2], 0)` % and `r FunDec(top.bottom[3,2], 0)` % respectively. The biggest decreases were in `r top.bottom[5,1]` (`r FunDec(abs(top.bottom[5,2]), 0)` %), and `r top.bottom[4,1]` (`r FunDec(abs(top.bottom[4,2]),0)` %). 


The table also shows the proportion of income taken up by costs in `r paste0(current.year, "-", current.year-1999)`. Nationally in Scotland it is `r format(round(sco.expend.p[3],1), nsmall = 1)` % with Glasgow at `r format(round(sco.expend.p[2],1), nsmall = 1)` % and Edinburgh at `r format(round(sco.expend.p[1],1), nsmall = 1)` %.



```{r expend, echo = FALSE, message = FALSE, warning = FALSE}

sco.expend %>% 
  mutate(change = paste(format(round(change, 1),nsmall = 1), "\\%"),
         prop.income = paste(format(round(prop.income, 1),nsmall = 1), "\\%")) %>% 
   kable( "latex", 
         booktabs = TRUE, 
         digits = 0, 
         escape = FALSE,
         longtable = TRUE,
         align = c("r"),
         caption = "Parking expenditure for Scotland (£,000)",
         format.args = list(big.mark = ","),
         linesep = "",
         col.names = c("\\multirow{1}{*}[0pt]{Local Authority}", yearz, 
                       paste0("Change ", current.year, "-", current.year-1999, 
                              " on ", current.year-1, "-", current.year-1999-1), "Expenditure as proportion of income")) %>% 
  kable_styling(full_width = TRUE, 
                latex_options =c("HOLD_position", "striped", "repeat_header"), 
                font_size = 10) %>% 
   column_spec(1, width = "3.3cm") %>% 
  column_spec(8, width = "1.8cm") %>% 
  row_spec(32, hline_after = TRUE)
  
```

\newpage

# Surpluses

